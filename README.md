# quick_scan_container_images_online_offline
This script is designed to streamline the Preflight scanning process for container images, whether Quay RESTAPI is utilized or not. Preflight scanning serves the purpose of assessing whether container images adhere to security best practices, specifically regarding CVE tests, without the need for submission to the Backend Catalog.

With the latest Preflight releases, the scanning capability has been enhanced to detect changes or removals of original UBI-based image files within multiple layers of Docker images. This scanning process serves as a preliminary check before submission to the backend, ensuring that all criteria are met.

The script produces test case results, which are initially displayed in the console and then exported to both CSV and XLS formats using a Python script.

## Pre-Requisites
- Clone this github repo then use the scripts  
- Login to Private Registry Server with `podman login -u xxx quay.io`
- To talk to Quay.io Or Private Registry via REST API, it requires oauth and bear token
- Push images to Quay Repository with specific Organization
- Python3 + Pandas and Openpyxl using `sudo pip3 install pandas openpyxl`   
  if `pip3` is not installed yet then `sudo dnf install python3-pip -y`
- netcat (nc) rpm installed if not there it will skip the connectivity checking
- Install preflight 
```shellSession
wget https://github.com/redhat-openshift-ecosystem/openshift-preflight/releases/download/1.12.0/preflight-linux-amd64
chmod +x preflight-linux-amd64
sudo mv preflight-linux-amd64 /usr/local/bin/preflight
```

## Quick Images Scan Shell Script Usage
```shellSession
$ bash quick_scan_container_images_online_offline.sh -h
------------------------------------------------------------------------------------------------------------------------
Usage (API-based):
    quick_scan_container_images_online_offline.sh -rn <repo_ns> -cp <cnf_prefix> [-t <tag_type>] -d <auth.json> -at <api_token> -fq <fqdn> [-ft <filter>]
    
    Description:
      -rn | --repo-ns
            The repository namespace: either an organization or a user name 
            (e.g., "avareg_5gc" or "avu0").
      
      -cp | --cnf-prefix
            The CNF image prefix to search for. This can be a specific prefix (e.g., "global-amf-rnic")
            or a wildcard/multiple prefixes separated by a pipe character (e.g., "global|non-global").
      
      -t | --tag-type (Optional)
            The image tag type: "name" to use the image tag, or "digest" to use the manifest digest.
            If omitted, the default is "name".
      
      -d | --auth-json
            The path to the Docker authentication JSON file (e.g., auth.json).
            If container image does not need docker auth, then it's optional.
      
      -at | --api-token
            The API token (Bearer Token) generated by the Registry Server Admin.
      
      -fq | --fqdn
            The fully-qualified domain name of your private registry (e.g., quay.io).
      
      -ft | --filter (Optional)
            A filter to exclude certain images. For example, use "existed_image|tested_image"
            to filter out images containing these strings.

Usage (Offline):
    quick_scan_container_images_online_offline.sh --img <image_list.txt> -d <auth.json> -fq <fqdn>
    
    Description:
      --img | --img-file
            A text file containing a list of images to scan (one image per line).
      
      The other options are the same as described above.

Additional Examples:
    Example 1 (API-based):
      quick_scan_container_images_online_offline.sh -rn ava -cp "global-|specific" -d auth.json -at xxxxxx -fq quay.io -t name -ft "existed_image|tested_image"
      
    Example 2 (API-based with defaults):
      quick_scan_container_images_online_offline.sh -rn avareg_5gc -cp global- -d auth.json -at xxxxxx -fq quay.io
      
    Example 3 (Offline):
      Private-Registry:
      quick_scan_container_images_online_offline.sh --img image_list.txt -d auth.json -fq quay.io
      
      Public-Registry:
      quick_scan_container_images_online_offline.sh --img image_list.txt -fq quay.io

Note:
    - Both "tag-type" and "log-type" (if used) are optional.
    - Ensure that all required files (like the authentication JSON) exist and are accessible.
------------------------------------------------------------------------------------------------------------------------
```
## Start Container Images Preflight Scan Automation With Quay RESTAPI
```shellSession
$ bash quick_scan_container_images_online_offline.sh -rn xxxxxxx_5gc -cp "busybox|simple"

Checking the pre-requirements steps...........
========================================================
Pre-Requirements Checking                      Status    
---------------------------------------------------------
python3 and preflight installed                  OK                      
quay.xxxxxxx.bos2.lab's Connection               OK                      
Registry Server Bearer-Token Access              OK                      
Python Pandas and Openpyxl installed             OK                      
Docker Authentication                            OK                      
=======================================================

Please be patient while scanning images...

Scaning the following image: rel-test/univ-box
======================================================
Image Name           Test Case                 Status    
------------------------------------------------------
univ-box    HasLicense                FAILED    
univ-box    HasUniqueTag              PASSED    
univ-box    LayerCountAcceptable      PASSED    
univ-box    HasNoProhibitedPackages   ERROR     
univ-box    HasRequiredLabel          FAILED    
univ-box    RunAsNonRoot              FAILED    
univ-box    HasModifiedFiles          ERROR     
univ-box    BasedOnUbi                FAILED    
======================================================
Verdict: FAILED    
Time elapsed: 2.533 seconds

Scaning the following image: rel-test/mongo/mdbm/notsimple
======================================================
Image Name           Test Case                 Status    
------------------------------------------------------
notsimple           HasLicense                FAILED    
notsimple           HasUniqueTag              PASSED    
notsimple           LayerCountAcceptable      PASSED    
notsimple           HasNoProhibitedPackages   ERROR     
notsimple           HasRequiredLabel          FAILED    
notsimple           RunAsNonRoot              PASSED    
notsimple           HasModifiedFiles          ERROR     
notsimple           BasedOnUbi                FAILED    
======================================================
Verdict: FAILED    
Time elapsed: 6.189 seconds
Total Number Images Scanned: 2
20230410-15:54:30 Successfully Converted from preflight_image_scan_result.csv to images_scan_results.xlsx!
```

- **Images Scan Console Output:** 
<!-- ![Images Scan Console Output](img/images_scan_console_output.png "Images Scan Console Output") -->

- **New Images Scan with Debug**
<!-- ![Images Scan XLSX Conversion Output](img/new-conversion-output.png "Images Scan XLSX Conversion New Output") -->

- **Images Scan XSLX Output:**   
<!-- ![Images Scan XLSX Conversion Output](img/images_scan_xlsx_conversion_ouput.png "Images Scan XLSX Conversion Output") -->

## Start Container Images Preflight Scan Automation Without Quay RESTAPI
When Partner do not have the priviledge to access Quay or private registry RESTAPI, they can dump the following format to a image_list.txt then the script it will read from this file and using preflight to scan images automatic.
Of course, there are some mandatory parameters that need to be defined before such as auth.json and registry-fqdn.  
**image_list.txt:**
```shellSession
quay.ava.lab/ava_5gc/ava-core/univ-smf-nec:v1
quay.ava.lab/ava_5gc/ava-core/univ-smf-nad:v1
quay.ava.lab/ava_5gc/ava-core/univ-nrf-att:v1
```
- How to run this script without Quay/Registry API (Offline)
Run it without any argument like this  
```shellSession
$ bash quick_scan_container_images_online_offline.sh bash -img image-test.txt -fq quay.io -d ./auth.json

Without Docker Authentication:
$ bash quick_scan_container_images_online_offline.sh bash -img image-test.txt -fq quay.io
```
